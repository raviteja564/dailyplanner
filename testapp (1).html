<!DOCTYPE html>
<html>
<head>
    <title>Daily Planner</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: auto; }
        .logout-button { background: #555; color: white; padding: 8px 15px; border: none; border-radius: 4px; position: absolute; top: 20px; right: 20px; cursor: pointer; }
        h1 { color: #2c3e50; text-align: center; }
        .task-container { margin-bottom: 20px; }
        .task-container input[type="text"] { padding: 8px; width: 60%; margin-right: 10px; }
        .task-container input[type="date"] { padding: 8px; margin-right: 10px; }
        .add-task-button { background: #2196F3; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; }
        .navigation { display: flex; justify-content: space-between; margin: 20px 0; }
        .nav-button { background: #FF9800; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; }
        .task-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .task-table th, .task-table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        .task-table th { background: #f5f5f5; }
        .completed-task { background: #e8f5e9; } /* Green for completed tasks */
        .skipped-task { background: #fff3e0; } /* Orange for skipped tasks */
        .delete-button { background: #ff4444; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
        .delete-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ddd; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); z-index: 1000; }
        .delete-popup button { background: #ff4444; color: black; padding: 8px 15px; border: none; border-radius: 4px; margin: 5px; cursor: pointer; }
        .graph-container { margin-top: 40px; }
        .graph-container h2 { color: #2c3e50; }
    </style>
</head>
<body>
    <button class="logout-button" onclick="logout()">Logout</button>
    <h1>Daily Planner</h1>

    <!-- Task Input -->
    <div class="task-container">
        <input type="text" id="taskInput" placeholder="Enter task...">
        <input type="date" id="expiryDate" min="">
        <button class="add-task-button" onclick="addTask()">Add Task</button>
    </div>

    <!-- Navigation -->
    <div class="navigation">
        <button class="nav-button" onclick="previousDay()">Previous Day</button>
        <span id="currentDateDisplay"></span>
        <button class="nav-button" onclick="nextDay()">Next Day</button>
    </div>

    <!-- Task List -->
    <table class="task-table" id="taskTable">
        <thead>
            <tr>
                <th>Task</th>
                <th>Status</th>
                <th>Notes</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="tasksList"></tbody>
    </table>

    <!-- Delete Popup -->
    <div class="delete-popup" id="deletePopup">
        <p>Are you sure you want to delete this task?</p>
        <button onclick="deleteForToday()">Delete for Today</button>
        <button onclick="deleteCompletely()">Delete Completely</button>
        <button onclick="closeDeletePopup()">Cancel</button>
    </div>

    <!-- Weekly Chart -->
    <div class="graph-container">
        <h2>Weekly Task Status</h2>
        <canvas id="weeklyChart"></canvas>
    </div>

<script>
// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyCVG1dE9X5b3YAX_tG_XKc01pKx-SlC-v0",
    authDomain: "dailyplanner-e9f7d.firebaseapp.com",
    projectId: "dailyplanner-e9f7d",
    storageBucket: "dailyplanner-e9f7d.firebasestorage.app",
    messagingSenderId: "1037126520",
    appId: "1:1037126520:web:ce7031339a68723991968d",
    measurementId: "G-CJ2T8M13Z7"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// App Data
let plannerData = { days: [] };
let currentDate = new Date().toLocaleDateString('en-CA');
let deleteTaskId = null;
let weeklyChartInstance = null;

// Firebase Auth Listener
auth.onAuthStateChanged(user => {
    if (user) {
        db.collection("users").doc(user.uid).get().then(doc => {
            if (doc.exists) plannerData = doc.data().plannerData || { days: [] };
            initializeApp();
        });
    } else {
        window.location.href = "login.html";
    }
});

// Initialize App
function initializeApp() {
    document.getElementById('expiryDate').min = currentDate;
    updateDateDisplay();
    loadDay(currentDate);
    renderCharts();
}

// Add Task
function addTask() {
    const taskName = document.getElementById('taskInput').value.trim();
    const expiryDate = document.getElementById('expiryDate').value;

    if (taskName && expiryDate) {
        const taskId = Date.now();
        const startDate = new Date(currentDate);
        const endDate = new Date(expiryDate);

        while (startDate <= endDate) {
            const dateStr = startDate.toISOString().split('T')[0];
            let day = plannerData.days.find(day => day.date === dateStr);
            
            if (!day) {
                day = { date: dateStr, tasks: [] };
                plannerData.days.push(day);
            }

            if (!day.tasks.some(task => task.id === taskId)) {
                day.tasks.push({ id: taskId, name: taskName, status: 'pending', notes: '' });
            }

            startDate.setDate(startDate.getDate() + 1);
        }

        saveData();
        loadDay(currentDate);
        renderCharts();
    }
}

// Load Tasks for Current Day
function loadDay(date) {
    currentDate = date;
    updateDateDisplay();
    const day = plannerData.days.find(d => d.date === date) || { tasks: [] };
    const tasksList = document.getElementById('tasksList');
    
    tasksList.innerHTML = day.tasks.map(task => `
        <tr class="${task.status}-task">
            <td>${task.name}</td>
            <td>
                <select onchange="updateStatus(${task.id}, this.value)">
                    <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                    <option value="skipped" ${task.status === 'skipped' ? 'selected' : ''}>Skip for Today</option>
                </select>
            </td>
            <td><input type="text" value="${task.notes || ''}" onchange="updateNotes(${task.id}, this.value)"></td>
            <td><button class="delete-button" onclick="openDeletePopup(${task.id})">Delete</button></td>
        </tr>
    `).join('');
}

// Update Date Display
function updateDateDisplay() {
    const dateDisplay = document.getElementById('currentDateDisplay');
    const date = new Date(currentDate);
    dateDisplay.textContent = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}

// Navigation Functions
function previousDay() {
    const date = new Date(currentDate);
    date.setDate(date.getDate() - 1);
    currentDate = date.toLocaleDateString('en-CA');
    loadDay(currentDate);
}

function nextDay() {
    const date = new Date(currentDate);
    date.setDate(date.getDate() + 1);
    currentDate = date.toLocaleDateString('en-CA');
    loadDay(currentDate);
}

// Render Weekly Chart
function renderCharts() {
    if (weeklyChartInstance) weeklyChartInstance.destroy();

    const weeklyData = getWeeklyData();
    const ctx = document.getElementById('weeklyChart').getContext('2d');
    
    weeklyChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: weeklyData.days,
            datasets: [
                { label: 'Completed', data: weeklyData.completed, backgroundColor: '#4CAF50' },
                { label: 'Pending', data: weeklyData.pending, backgroundColor: '#2196F3' },
                { label: 'Skipped', data: weeklyData.skipped, backgroundColor: '#FF9800' }
            ]
        },
        options: {
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Number of Tasks' } },
                x: { title: { display: true, text: 'Days' } }
            }
        }
    });
}

// Get Weekly Data for Chart
function getWeeklyData() {
    const today = new Date();
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay());
    const endOfWeek = new Date(today);
    endOfWeek.setDate(today.getDate() + (6 - today.getDay()));

    const days = [];
    const completed = [];
    const pending = [];
    const skipped = [];

    for (let d = new Date(startOfWeek); d <= endOfWeek; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        days.push(dateStr);

        const day = plannerData.days.find(day => day.date === dateStr) || { tasks: [] };
        completed.push(day.tasks.filter(task => task.status === 'completed').length);
        pending.push(day.tasks.filter(task => task.status === 'pending').length);
        skipped.push(day.tasks.filter(task => task.status === 'skipped').length);
    }

    return { days, completed, pending, skipped };
}

// Save Data to Firebase
function saveData() {
    if (auth.currentUser) {
        db.collection("users").doc(auth.currentUser.uid).set({ plannerData }, { merge: true });
    }
}

// Logout
function logout() {
    auth.signOut().then(() => window.location.href = "login.html");
}
</script>
</body>
</html>
