<!DOCTYPE html>
<html>
<head>
    <title>Daily Planner with Enhanced Graphs</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: auto; }
        .task-container { margin-bottom: 20px; }
        .task-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .task-table th, .task-table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        .task-table th { background: #f5f5f5; }
        .task-table td { vertical-align: middle; }
        input[type="text"] { padding: 8px; width: 100%; box-sizing: border-box; }
        select { padding: 8px; width: 100%; box-sizing: border-box; }
        button { padding: 8px 15px; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .today-button { background: #4CAF50; }
        .nav-button { background: #FF9800; }
        .delete-button { background: #ff4444; }
        .calendar { margin: 20px 0; display: flex; justify-content: space-between; }
        .calendar-day { 
            width: 13%; 
            padding: 10px; 
            text-align: center; 
            border: 1px solid #ddd; 
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .calendar-day.today { background: #4CAF50; color: white; }
        .calendar-day.selected { background: #2196F3; color: white; }
        .calendar-day.has-tasks { background: #fff3e0; }
        .expiry-selector { margin: 10px 0; }
        .navigation { display: flex; justify-content: space-between; margin: 10px 0; gap: 10px; }
        .completed-task { background: #e8f5e9; }
        .skipped-task { background: #fff3e0; }
        .delete-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ddd; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); z-index: 1000; }
        .delete-popup button { margin: 5px; }
        .graph-container { margin-top: 40px; }
        .graph-container div { margin-bottom: 40px; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCVG1dE9X5b3YAX_tG_XKc01pKx-SlC-v0",
        authDomain: "dailyplanner-e9f7d.firebaseapp.com",
        projectId: "dailyplanner-e9f7d",
        storageBucket: "dailyplanner-e9f7d.firebasestorage.app",
        messagingSenderId: "1037126520",
        appId: "1:1037126520:web:ce7031339a68723991968d",
        measurementId: "G-CJ2T8M13Z7"
      };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
    </script>
</head>
<body>
    <h1>Daily Planner with Enhanced Graphs</h1>

    <!-- Task Input -->
    <div class="task-container">
        <input type="text" id="taskInput" placeholder="Enter task...">
        <div class="expiry-selector">
            <label for="expiryDate">Expiry Date:</label>
            <input type="date" id="expiryDate" min="">
        </div>
        <button onclick="addTask()">Add Task</button>
    </div>

    <!-- Navigation -->
    <div class="navigation">
        <button class="nav-button" onclick="previousWeek()">Previous</button>
        <span id="currentRange"></span>
        <button class="nav-button" onclick="nextWeek()">Next</button>
        <button class="today-button" onclick="highlightToday()">Today</button>
        <button class="nav-button" onclick="logout()">Logout</button>
    </div>

    <!-- Calendar -->
    <div class="calendar" id="calendar"></div>

    <!-- Task List -->
    <table class="task-table" id="taskTable">
        <thead>
            <tr>
                <th>Task</th>
                <th>Status</th>
                <th>Notes</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="tasksList"></tbody>
    </table>

    <!-- Delete Popup -->
    <div class="delete-popup" id="deletePopup">
        <p>Are you sure you want to delete this task?</p>
        <button onclick="deleteForToday()">Delete for Today</button>
        <button onclick="deleteCompletely()">Delete Completely</button>
        <button onclick="closeDeletePopup()">Cancel</button>
    </div>

    <!-- Graphs -->
    <div class="graph-container">
        <div>
            <h2>Weekly Status</h2>
            <canvas id="weeklyChart"></canvas>
        </div>
        <div>
            <h2>Monthly Status</h2>
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>

<script>
// Chart instances and data
let weeklyChartInstance = null;
let monthlyChartInstance = null;
let plannerData = { days: [] };
let currentDate = new Date().toLocaleDateString('en-CA');
let currentStartDate = new Date();
let deleteTaskId = null;

// Firebase Auth Listener
auth.onAuthStateChanged(user => {
  if (user) {
    db.collection("users").doc(user.uid).get().then(doc => {
      plannerData = doc.exists ? doc.data().plannerData : { days: [] };
      initializeApp();
    });
  } else {
    window.location.href = "login.html";
  }
});

function initializeApp() {
  if (!plannerData.days.some(day => day.date === currentDate)) {
    plannerData.days.push({ date: currentDate, tasks: [] });
    saveData();
  }
  
  document.getElementById('expiryDate').min = currentDate;
  updateUI();
}

function updateUI() {
  renderCalendar();
  loadDay(currentDate);
  renderCharts();
  updateNavigation();
}

function renderCalendar() {
  const calendar = document.getElementById('calendar');
  calendar.innerHTML = '';
  
  const startDate = new Date(currentStartDate);
  startDate.setDate(startDate.getDate() - 3);

  for (let i = 0; i < 7; i++) {
    const date = new Date(startDate);
    date.setDate(date.getDate() + i);
    const dateStr = date.toISOString().split('T')[0];
    
    const isToday = dateStr === new Date().toLocaleDateString('en-CA');
    const isSelected = dateStr === currentDate;
    const hasTasks = plannerData.days.some(d => d.date === dateStr && d.tasks.length > 0);

    calendar.innerHTML += `
      <div class="calendar-day 
        ${isToday ? 'today' : ''} 
        ${isSelected ? 'selected' : ''}
        ${hasTasks ? 'has-tasks' : ''}" 
        onclick="loadDay('${dateStr}')">
        ${date.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' })}
      </div>
    `;
  }
}

function loadDay(date) {
  currentDate = date;
  const day = plannerData.days.find(d => d.date === date) || { tasks: [] };
  const tasksList = document.getElementById('tasksList');
  
  tasksList.innerHTML = day.tasks.map(task => `
    <tr class="${task.status}-task">
      <td>${task.name}</td>
      <td>
        <select onchange="updateStatus(${task.id}, this.value)">
          <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>Pending</option>
          <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
          <option value="skipped" ${task.status === 'skipped' ? 'selected' : ''}>Skip for the Day</option>
        </select>
      </td>
      <td>
        <input type="text" value="${task.notes || ''}" 
               onchange="updateNotes(${task.id}, this.value)">
      </td>
      <td>
        <button class="delete-button" onclick="openDeletePopup(${task.id})">Delete</button>
      </td>
    </tr>
  `).join('');
  
  renderCalendar();
}

function renderCharts() {
  if (weeklyChartInstance) weeklyChartInstance.destroy();
  if (monthlyChartInstance) monthlyChartInstance.destroy();

  const weeklyData = getWeeklyData();
  const monthlyData = getMonthlyData();

  weeklyChartInstance = new Chart(document.getElementById('weeklyChart'), {
    type: 'bar',
    data: {
      labels: weeklyData.days.map(d => new Date(d).toLocaleDateString()),
      datasets: [
        { label: 'Completed', data: weeklyData.completed, backgroundColor: '#4CAF50' },
        { label: 'Skipped', data: weeklyData.skipped, backgroundColor: '#FF9800' },
        { label: 'Pending', data: weeklyData.pending, backgroundColor: '#2196F3' }
      ]
    }
  });

  monthlyChartInstance = new Chart(document.getElementById('monthlyChart'), {
    type: 'bar',
    data: {
      labels: monthlyData.days.map(d => new Date(d).getDate()),
      datasets: [
        { label: 'Completed', data: monthlyData.completed, backgroundColor: '#4CAF50' },
        { label: 'Skipped', data: monthlyData.skipped, backgroundColor: '#FF9800' },
        { label: 'Pending', data: monthlyData.pending, backgroundColor: '#2196F3' }
      ]
    }
  });
}

// Keep all other functions (addTask, updateStatus, delete functions, etc.) 
// from previous implementation but replace saveData() calls with updateUI()
// and ensure all date navigation functions use week-based navigation

function previousWeek() {
  currentStartDate.setDate(currentStartDate.getDate() - 7);
  updateUI();
}

function nextWeek() {
  currentStartDate.setDate(currentStartDate.getDate() + 7);
  updateUI();
}

function highlightToday() {
  currentStartDate = new Date();
  currentDate = new Date().toLocaleDateString('en-CA');
  updateUI();
}

function saveData() {
  if (auth.currentUser) {
    db.collection("users").doc(auth.currentUser.uid).set({
      plannerData: plannerData
    }, { merge: true });
  }
}

function logout() {
  auth.signOut().then(() => window.location.href = "login.html");
}

// Keep getWeeklyData and getMonthlyData functions unchanged from original
</script>
</body>
</html>
