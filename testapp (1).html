<script>
// Chart instances
let weeklyChartInstance = null;
let monthlyChartInstance = null;

// Data structure
let plannerData = { days: [] };
let currentDate = new Date().toLocaleDateString('en-CA');
let currentStartDate = new Date();
let deleteTaskId = null;

// Firebase Auth Listener
auth.onAuthStateChanged(user => {
  if (user) {
    db.collection("users").doc(user.uid).get().then(doc => {
      if (doc.exists) {
        plannerData = doc.data().plannerData || { days: [] };
      }
      initializeApp();
    });
  } else {
    window.location.href = "login.html";
  }
});

function initializeApp() {
  // Initialize current day if missing
  if (!plannerData.days.some(day => day.date === currentDate)) {
    plannerData.days.push({
      date: currentDate,
      tasks: []
    });
    saveData();
  }

  document.getElementById('expiryDate').min = currentDate;
  renderCalendar();
  loadDay(currentDate);
  renderCharts();
}

// Modified renderCalendar to show 7-day view
function renderCalendar() {
  const calendar = document.getElementById('calendar');
  calendar.innerHTML = '';
  
  const startDate = new Date(currentStartDate);
  startDate.setDate(startDate.getDate() - 3); // Show 7-day window

  for (let i = 0; i < 7; i++) {
    const date = new Date(startDate);
    date.setDate(startDate.getDate() + i);
    const dateStr = date.toISOString().split('T')[0];
    
    const isToday = dateStr === new Date().toLocaleDateString('en-CA');
    const isSelected = dateStr === currentDate;
    const dayExists = plannerData.days.some(d => d.date === dateStr);

    calendar.innerHTML += `
      <div class="calendar-day 
        ${isToday ? 'today' : ''} 
        ${isSelected ? 'selected' : ''}
        ${dayExists ? 'has-tasks' : ''}" 
        onclick="loadDay('${dateStr}')>
        ${date.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' })}
      </div>
    `;
  }
}

// Modified renderCharts to handle updates
function renderCharts() {
  // Destroy existing charts
  if (weeklyChartInstance) weeklyChartInstance.destroy();
  if (monthlyChartInstance) monthlyChartInstance.destroy();

  const weeklyData = getWeeklyData();
  const monthlyData = getMonthlyData();

  // Weekly Chart
  const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
  weeklyChartInstance = new Chart(weeklyCtx, {
    type: 'bar',
    data: {
      labels: weeklyData.days.map(d => new Date(d).getDate()),
      datasets: [
        { label: 'Completed', data: weeklyData.completed, backgroundColor: '#4CAF50' },
        { label: 'Skipped', data: weeklyData.skipped, backgroundColor: '#FF9800' },
        { label: 'Pending', data: weeklyData.pending, backgroundColor: '#2196F3' }
      ]
    },
    options: { scales: { y: { beginAtZero: true } }
  });

  // Monthly Chart
  const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
  monthlyChartInstance = new Chart(monthlyCtx, {
    type: 'bar',
    data: {
      labels: monthlyData.days.map(d => new Date(d).getDate()),
      datasets: [
        { label: 'Completed', data: monthlyData.completed, backgroundColor: '#4CAF50' },
        { label: 'Skipped', data: monthlyData.skipped, backgroundColor: '#FF9800' },
        { label: 'Pending', data: monthlyData.pending, backgroundColor: '#2196F3' }
      ]
    },
    options: { scales: { y: { beginAtZero: true } }
  });
}

// Add this to all functions that modify data
function updateUI() {
  loadDay(currentDate);
  renderCalendar();
  renderCharts();
  saveData();
}

// Modified addTask function
function addTask() {
  const input = document.getElementById('taskInput');
  const expiryDate = document.getElementById('expiryDate').value;
  const taskName = input.value.trim();
  
  if (taskName && expiryDate) {
    const taskId = Date.now();
    const startDate = new Date(currentDate);
    const endDate = new Date(expiryDate);

    // Add task to all days
    while (startDate <= endDate) {
      const dateStr = startDate.toISOString().split('T')[0];
      let day = plannerData.days.find(day => day.date === dateStr);
      
      if (!day) {
        day = { date: dateStr, tasks: [] };
        plannerData.days.push(day);
      }

      if (!day.tasks.some(task => task.id === taskId)) {
        day.tasks.push({
          id: taskId,
          name: taskName,
          status: 'pending',
          notes: ''
        });
      }
      startDate.setDate(startDate.getDate() + 1);
    }
    
    input.value = '';
    updateUI(); // Use unified update
  }
}

// Modified delete functions
function deleteForToday() {
  const day = plannerData.days.find(day => day.date === currentDate);
  if (day) {
    day.tasks = day.tasks.filter(task => task.id !== deleteTaskId);
    updateUI();
  }
  closeDeletePopup();
}

function deleteCompletely() {
  plannerData.days.forEach(day => {
    day.tasks = day.tasks.filter(task => task.id !== deleteTaskId);
  });
  updateUI();
  closeDeletePopup();
}

// Keep other functions same but replace saveData() calls with updateUI()
</script>
